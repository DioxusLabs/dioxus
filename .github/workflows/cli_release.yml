name: Build CLI for Release

# Will run automatically on every new release
on:
  release:
    types: [published]

jobs:
  build-and-upload:
    permissions:
      contents: write
    runs-on: ${{ matrix.platform.os }}
    strategy:
      matrix:
        platform:
          - {
              target: x86_64-pc-windows-msvc,
              os: windows-latest,
              toolchain: "1.70.0",
            }
          - {
              target: x86_64-apple-darwin,
              os: macos-latest,
              toolchain: "1.70.0",
            }
          - {
              target: x86_64-unknown-linux-gnu,
              os: ubuntu-latest,
              toolchain: "1.70.0",
            }
    steps:
      - uses: actions/checkout@v3
      - name: Install stable
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.platform.toolchain }}
          targets: ${{ matrix.platform.target }}

      # Setup the Github Actions Cache for the CLI package
      - name: Setup cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: packages/cli -> ../../target

      # Replace the tag for the cargo-binstall record with the current release tag
      - name: Replace pkg-url in Cargo.toml and push changes to tag # Only run on Linux
        if: ${{matrix.platform.target == 'x86_64-unknown-linux-gnu'}}
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Replace the tag for the cargo-binstall record with the current release tag
          sed -i 's/\/{ tagName }\//\/${{ github.event.release.tag_name }}\//g' packages/cli/Cargo.toml

          # Get release body from GitHub CLI
          release_body=$(gh release view ${{ github.event.release.tag_name }} --json body --jq '.body')

          # Commit and push the changes to the tag
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com" # This is a dummy email, copied from https://github.com/stefanzweifel/git-auto-commit-action
          git config --local user.name "github-actions[bot]"
          git add packages/cli/Cargo.toml
          git commit -m "Update pkg-url to ${{ github.event.release.tag_name }}"
          git tag -fa ${{ github.event.release.tag_name }} -m "release_body"
          git push origin --tags --force

      # This neat action can build and upload the binary in one go!
      - name: Build and upload binary
        uses: taiki-e/upload-rust-binary-action@v1
        with:
          ref: refs/tags/${{ github.event.release.tag_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          target: ${{ matrix.platform.target }}
          bin: dx
          archive: dx-${{ matrix.platform.target }}
          checksum: sha256
          manifest_path: packages/cli/Cargo.toml
